<div class="latestpost-bg">
  <div class="container">
    <h1>Latest Blogs</h1>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="Physics">
        <img src="physics-icon.png" alt="Physics Icon" /> Physics
      </button>
      <button class="filter-btn" data-filter="Chemistry">
        <img src="chemistry-icon.png" alt="Chemistry Icon" /> Chemistry
      </button>
      <button class="filter-btn" data-filter="Biology">
        <img src="biology-icon.png" alt="Biology Icon" /> Biology
      </button>
    </div>

    <!-- Skeleton Loader (Shown while posts are being fetched) -->
    <div id="skeletonLoader" class="cards-section">
      <!-- Skeleton cards here -->
    </div>

    <!-- Blog Cards Container -->
    <div id="blog-container" class="cards-section"></div>

    <!-- Load More Button -->
    <button id="load-more-btn" style="display: none;">Load More</button>
    <!-- End Message -->
    <p id="end-message" style="display: none;">That's all!</p>
  </div>
</div>

<script>
  const cloudflareProxy = 'https://neetstudyhub-api-proxy.earnmoney100a.workers.dev/';
  const maxResults = 100;
  const postsPerBatch = 6;

  let latestPosts = [];
  let displayedPosts = 0;
  let activeFilter = "Physics";

  const blogContainer = document.getElementById('blog-container');
  const loadMoreBtn = document.getElementById('load-more-btn');
  const skeletonLoader = document.getElementById('skeletonLoader');
  const endMessage = document.getElementById('end-message');
  const filterButtons = document.querySelectorAll('.filter-btn');

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString(undefined, options);
  }

  function extractImageFromContent(content) {
    const imgTagMatch = content.match(/<img[^>]+src="([^">]+)"/);
    return imgTagMatch ? imgTagMatch[1] : 'https://via.placeholder.com/500x300';
  }

  function extractDownloadLink(content) {
    const downloadButtonMatch = content.match(/<a[^>]+class="download-button"[^>]+href="([^">]+)"/);
    return downloadButtonMatch ? downloadButtonMatch[1] : '#';
  }

  async function fetchBloggerPosts() {
    try {
      const response = await fetch(`${cloudflareProxy}?maxResults=${maxResults}`);
      const data = await response.json();

      if (!data.items || data.items.length === 0) {
        throw new Error("No posts found.");
      }

      const filteredPosts = data.items.filter(
        (post) =>
          post.labels &&
          post.labels.some((label) =>
            ["Physics", "Chemistry", "Biology"].includes(label)
          )
      );

      latestPosts = await Promise.all(
        filteredPosts.map((post) => {
          const { id, title, content, labels, published } = post;
          const imageUrl = post.images?.[0]?.url || extractImageFromContent(content);
          const formattedDate = published ? formatDate(published) : "Unknown Date";
          const contentSnippet = content.replace(/<\/?[^>]+(>|$)/g, "").substring(0, 120);
          const downloadLink = extractDownloadLink(content);
          return {
            id,
            title,
            labels: labels || [],
            imageUrl,
            published: formattedDate,
            contentSnippet,
            downloadLink,
          };
        })
      );

      skeletonLoader.style.display = "none";
      filterAndDisplayPosts();
    } catch (error) {
      console.error("Error fetching posts:", error);
      skeletonLoader.style.display = "none";
      blogContainer.innerHTML = `<p>Error loading posts. Please try again.</p>`;
    }
  }

  function filterAndDisplayPosts() {
    const filteredPosts = latestPosts.filter((post) =>
      post.labels.includes(activeFilter)
    );
    displayedPosts = 0;
    blogContainer.innerHTML = "";
    displayPosts(filteredPosts);
  }

  function displayPosts(posts) {
    const postsToDisplay = posts.slice(displayedPosts, displayedPosts + postsPerBatch);
    const postCards = postsToDisplay.map((post) => {
      const { id, title, labels, imageUrl, published, contentSnippet, downloadLink } = post;
      const labelMarkup = labels.map((label) => `<span class="label">${label}</span>`).join(" ");
      return `
        <div class="card">
          <a href="post.html?postId=${id}" target="_self">
            <div class="card-image">
              <img src="${imageUrl}" alt="${title}" />
            </div>
          </a>
          <div class="card-content">
            <div class="top-labels">${labelMarkup}</div>
            <h3>
              <a href="post.html?postId=${id}" target="_self">${title}</a>
            </h3>
            <p class="post-description">${contentSnippet}...</p>
            <div class="buttons">
              <a href="post.html?postId=${id}" class="view-button">View</a>
              <a href="${downloadLink}" class="download-button" target="_blank">Download</a>
            </div>
            <div class="bottom-meta">
              <div class="date-logo">
                <img src="date-logo.png" alt="Date Logo" />
              </div>
              <span class="published-date">Mental Ease â€¢ ${published}</span>
            </div>
          </div>
        </div>
      `;
    });

    blogContainer.innerHTML += postCards.join("");
    displayedPosts += postsToDisplay.length;

    if (displayedPosts >= posts.length) {
      loadMoreBtn.style.display = "none";
      endMessage.style.display = "block";
    } else {
      loadMoreBtn.style.display = "block";
    }
  }

  loadMoreBtn.addEventListener("click", () => {
    const filteredPosts = latestPosts.filter((post) =>
      post.labels.includes(activeFilter)
    );
    displayPosts(filteredPosts);
  });

  filterButtons.forEach((button) => {
    button.addEventListener("click", () => {
      filterButtons.forEach((btn) => btn.classList.remove("active"));
      button.classList.add("active");
      activeFilter = button.getAttribute("data-filter");
      filterAndDisplayPosts();
    });
  });

  document.addEventListener("DOMContentLoaded", fetchBloggerPosts);
</script>
