<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCERT Posts</title>
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f4f8;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #007bff;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
    }

    main {
      padding: 1rem;
    }

    /* Filters */
    #myodf-class-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    #myodf-class-buttons button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #myodf-class-buttons button:hover {
      background-color: #0056b3;
    }

    #myodf-subjects {
      display: block;
      margin: 0 auto 1rem auto;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-width: 200px;
      text-align: center;
    }

    /* Posts Grid */
    #myodf-posts-container {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    /* Post Card */
    .myodf-post-card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.3s ease;
    }

    .myodf-post-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .myodf-post-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .myodf-post-card-content {
      padding: 1rem;
    }

    .myodf-post-card-content h3 {
      font-size: 1.25rem;
      margin: 0 0 0.5rem 0;
    }

    .myodf-post-card-content p {
      font-size: 0.9rem;
      margin: 0.5rem 0;
    }

    .myodf-post-actions {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
    }

    .myodf-download-button,
    .myodf-view-button {
      background-color: #007bff;
      color: #fff;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    .myodf-download-button:hover,
    .myodf-view-button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <h1>NCERT Posts</h1>
  </header>
  <main>
    <div id="myodf-class-buttons">
      <button data-class="11">Class 11</button>
      <button data-class="12">Class 12</button>
    </div>
    <select id="myodf-subjects">
      <option value="all">All Subjects</option>
      <option value="biology">Biology</option>
      <option value="physics">Physics</option>
      <option value="chemistry">Chemistry</option>
      <option value="maths">Maths</option>
    </select>
    <div id="myodf-posts-container">
      <!-- Posts will be dynamically added here -->
    </div>
  </main>
  <script>
    const cloudflareProxy = 'https://neetstudyhub-api-proxy.earnmoney100a.workers.dev'; // Cloudflare Worker URL

    const classButtons = document.getElementById('myodf-class-buttons');
    const subjectDropdown = document.getElementById('myodf-subjects');
    const postsContainer = document.getElementById('myodf-posts-container');

    // State
    let fetchedPosts = []; // To store all fetched posts
    let selectedClass = null;
    let selectedSubject = 'all';

    // Fetch NCERT posts initially
    async function fetchNcertPosts() {
      try {
        postsContainer.innerHTML = '<p>Loading...</p>';
        const response = await fetch(`${cloudflareProxy}?maxResults=500`);
        const data = await response.json();

        // Filter and store posts with "NCERT" label
        fetchedPosts = data.items.filter((post) => {
          const labels = post.labels ? post.labels.map((label) => label.toLowerCase()) : [];
          return labels.includes('ncert'); // Only include posts with "NCERT" label
        });

        // Display posts
        filterAndDisplayPosts();
      } catch (error) {
        console.error('Error fetching NCERT posts:', error);
        postsContainer.innerHTML = '<p>Error loading posts. Please try again later.</p>';
      }
    }

    // Filter and display posts based on class and subject
    function filterAndDisplayPosts() {
      const filteredPosts = fetchedPosts.filter((post) => {
        const labels = post.labels ? post.labels.map((label) => label.toLowerCase()) : [];
        const isClassMatch = !selectedClass || labels.includes(`class ${selectedClass}`);
        const isSubjectMatch = selectedSubject === 'all' || labels.includes(selectedSubject.toLowerCase());
        return isClassMatch && isSubjectMatch;
      });

      if (filteredPosts.length > 0) {
        const posts = filteredPosts.map((post) => {
          const imageUrl = post.images && post.images[0] ? post.images[0].url : extractImageFromContent(post.content);
          const downloadLink = extractDownloadLink(post.content);

          return `
            <div class="myodf-post-card">
              <img src="${imageUrl}" alt="${post.title}">
              <div class="myodf-post-card-content">
                <h3>${post.title}</h3>
                <p><strong>Class:</strong> ${getLabel(post.labels, 'class')} | <strong>Subject:</strong> ${getLabel(post.labels, selectedSubject)}</p>
                <p><strong>Labels:</strong> ${post.labels ? post.labels.join(', ') : 'No labels'}</p>
                <div class="myodf-post-actions">
                  <a href="${downloadLink}" class="myodf-download-button" target="_blank">Download</a>
                  <a href="post.html?postId=${post.id}" class="myodf-view-button" target="_self">View</a>
                </div>
              </div>
            </div>
          `;
        });

        postsContainer.innerHTML = posts.join('');
      } else {
        postsContainer.innerHTML = '<p>No posts found for the selected criteria.</p>';
      }
    }

    // Extract the first image from content
    function extractImageFromContent(content) {
      const imgTagMatch = content.match(/<img[^>]+src="([^">]+)"/);
      return imgTagMatch ? imgTagMatch[1] : 'https://via.placeholder.com/300x200';
    }

    // Extract the download link from content
    function extractDownloadLink(content) {
      const downloadButtonMatch = content.match(/<a[^>]+class="download-button"[^>]+href="([^">]+)"/);
      return downloadButtonMatch ? downloadButtonMatch[1] : '#';
    }

    // Get specific label from labels
    function getLabel(labels, prefix) {
      if (!labels) return 'N/A';
      const label = labels.find((l) => l.toLowerCase().startsWith(prefix.toLowerCase()));
      return label ? label.split(' ')[1] : 'N/A';
    }

    // Handle class button clicks
    classButtons.addEventListener('click', (event) => {
      if (event.target.tagName === 'BUTTON') {
        // Update selected class
        selectedClass = event.target.dataset.class;

        // Reset subject dropdown to "all"
        subjectDropdown.value = 'all';
        selectedSubject = 'all';

        // Filter and display posts
        filterAndDisplayPosts();
      }
    });

    // Handle subject dropdown change
    subjectDropdown.addEventListener('change', (event) => {
      // Update selected subject
      selectedSubject = event.target.value.toLowerCase();

      // Filter and display posts
      filterAndDisplayPosts();
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', fetch
